@page "/agregarInscripcion/{Id:int?}"
@inject NavigationManager Navegador
@inject AgregarInscripcionUseCase AgregarInscripcionUseCase
@inject ObtenerInscripcionUseCase ObtenerInscripcionUseCase
@inject ModificarInscripcionUseCase ModificarInscripcionUseCase
@inject ListarCursosUseCase ListarCursosUseCase
@inject ObtenerCursoUseCase ObtenerCursoUseCase
@inject ListarEstudiantesUseCase ListarEstudiantesUseCase
@inject ObtenerEstudianteUseCase ObtenerEstudianteUseCase

@if (_nuevaInscripcion)
{
    <h1>A침adir inscripci칩n:</h1>    
}else
{
    <h2>Modificando inscripci칩n de @_inscripcion.Estudiante?.Nombre @_inscripcion.Estudiante?.Apellido al curso 
        @_inscripcion.Curso?.Titulo:</h2>
}

@if (_se_creo)
{
    <p class='alert alert-success'> Inscripci칩n creada.</p>
}

<!--<input placeholder="Ingrese nombre del estudiante" @bind="_inscripcion.Estudiante?.Nombre" class="form-control">
<input placeholder="Ingrese apellido del estudiante" @bind="_inscripcion.Estudiante?.Apellido" class="form-control">
<input type='email' placeholder="Ingrese email" @bind="_inscripcion.Estudiante?.Email" class="form-control">
<input type='number' placeholder="Ingrese DNI" @bind="_inscripcion.Estudiante?.Dni" class="form-control">-->
<label>Elija un estudiante</label>
<select @bind="_estudianteSeleccionado" class="form-control" required>
    @foreach (var estudiante in _listaEstudiantes)
    {
        <option value="@estudiante.Id">DNI:@estudiante.Dni <br>
                                        Nombre y apellido: @estudiante.Nombre @estudiante.Apellido <br>
                                        Email: @estudiante.Email <br>
        </option>        
    }
</select>

<label>Elija un curso</label>
<select @bind="_cursoSeleccionado" class="form-control">
    @foreach (var curso in _listaCursos)
    {
        <option value="@curso.Id">@curso.Titulo - @curso.Descripcion - @curso.Fecha_inicio - @curso.Fecha_finalizacion</option>        
    }
</select>
<input type="datetime-local" @bind="_inscripcion.Fecha_inscripcion" class="form-control">


<!--<input placeholder="Titulo" @bind="_inscripcion.Curso?.Titulo" class="form-control">
<input placeholder="Descripcion" @bind="_inscripcion.Curso?.Descripcion" class="form-control">
<input type="datetime-local" placeholder="Fecha de inicio" @bind="_inscripcion.Curso?.Fecha_inicio" class="form-control">
<input type="datetime-local" placeholder="Fecha de finalizacion" @bind="_inscripcion.Curso?.Fecha_finalizacion" class="form-control">-->

<button class="btn btn-primary" @onclick="Aceptar">Aceptar</button>

@_cursoSeleccionado
@_estudianteSeleccionado

@code 
{
    Inscripcion _inscripcion = new Inscripcion();
    Estudiante? _estudiante= new Estudiante();
    Curso? _curso= new Curso();
    int _estudianteSeleccionado;
    int _cursoSeleccionado;
    List<Estudiante> _listaEstudiantes= new List<Estudiante>();
    List<Curso> _listaCursos= new List<Curso>();
    [Parameter] public int? Id { get; set; }
    bool _nuevaInscripcion = true;
    bool _se_creo = false;
    bool _se_modifico = false;

    protected override void OnInitialized()
    {
        _listaEstudiantes= ListarEstudiantesUseCase.Ejecutar();
        _listaCursos= ListarCursosUseCase.Ejecutar();
    }
    
    protected override void OnParametersSet()
    {
        if(Id != null)  // se recibe un id en el path
        {
            var inscripcion_hallada = ObtenerInscripcionUseCase.Ejecutar(Id.Value);
            if(inscripcion_hallada != null)
            {
                _inscripcion = inscripcion_hallada; // se recupera una inscripcion para ese id
                _nuevaInscripcion = false;
            }
        }
    }
            
    void Aceptar()
    {
        _estudiante= ObtenerEstudianteUseCase?.Ejecutar(_estudianteSeleccionado);
        _curso= ObtenerCursoUseCase.Ejecutar(_cursoSeleccionado);
        if(_nuevaInscripcion)
        {
            _inscripcion.Estudiante= _estudiante;
            _inscripcion.Curso= _curso;
            AgregarInscripcionUseCase.Ejecutar(_inscripcion);
            _se_creo = true;
            _inscripcion = new Inscripcion();
            Navegador.NavigateTo("/agregarInscripcion");
        }else
        {
            _inscripcion.Estudiante= _estudiante;
            _inscripcion.Curso= _curso;
            ModificarInscripcionUseCase.Ejecutar(_inscripcion);
            _se_modifico = true;
            Navegador.NavigateTo($"/listadoInscripciones/{_se_modifico}");
        }
        
    }
}